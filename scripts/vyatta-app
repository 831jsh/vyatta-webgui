
# orig op/cfg env variables
export vyatta_prefix=/opt/vyatta
export vyatta_datarootdir=$vyatta_prefix/share
export vyatta_exec_prefix=$vyatta_prefix
export vyatta_bindir=$vyatta_exec_prefix/bin
export vyatta_sbindir=$vyatta_exec_prefix/sbin
export vyatta_libdir=$vyatta_exec_prefix/lib
export vyatta_datadir=$vyatta_datarootdir
export vyatta_localstatedir=$vyatta_prefix/var
export vyatta_sysconfdir=$vyatta_prefix/etc
export vyatta_op_templates=$vyatta_datadir/vyatta-op/templates
export vyatta_cfg_templates=$vyatta_datadir/vyatta-cfg/templates
export vyatta_configdir=$vyatta_prefix/config
export VYATTA_ACTIVE_CONFIGURATION_DIR=$vyatta_configdir/active
export VYATTA_CONFIG_TEMPLATE=$vyatta_cfg_templates
export VYATTA_TAG_NAME=node.tag
export VYATTA_MOD_NAME=.modified
export VYATTA_CFG_GROUP_NAME=vyattacfg
export VYATTA_EDIT_LEVEL=/
export VYATTA_TEMPLATE_LEVEL=/

# app variables
declare vyatta_app_templates='/opt/vyatta/share/vyatta-app/templates/'
declare -r _vyatta_app_last_comp_init='>>>>>>LASTCOMP<<<<<<'
declare _vyatta_app_last_comp=${_vyatta_app_last_comp_init}

#sets the alias hooks for the cmds
_vyatta_app_init ()
{
    complete -F _vyatta_app_expand ''

    for xd in $vyatta_app_templates/* ; do
        if [ -d $xd ] ; then
            cmd=${xd##*/}
            complete -F _vyatta_app_expand $cmd
            eval alias $cmd=\'_vyatta_app_run $cmd\'
        fi
    done

    bind 'set show-all-if-ambiguous on'
    shopt -s histverify
}


#parsing the node.def cmd
_vyatta_app_get_node_def_field ()
{
    local file=$1 field=$2

    sed -n '/^'"$field"':/,$ {
# strip field name and hold rest of line
    s/[a-z]*: *//
    h
    :b
# at EOF, print hold buffer and quit
    $ { x; p; q }
# input next line
    n
# if start of another field def, print hold buf and quit
    /^[a-z]*:/ { x; p; q }
# add to hold buf and branch to input next line
    H
    bb
    }' $file
}

#main run
_vyatta_app_run ()
{
    local -i estat
    local tpath=$vyatta_app_templates
    local restore_shopts=$( shopt -p extglob nullglob | tr \\n \; )
    shopt -s extglob nullglob

    _vyatta_app_last_comp=${_vyatta_app_last_comp_init}
    false; estat=$?
    for arg ; do
        if [ -f "$tpath/$arg/node.def" ] ; then
            tpath+=/$arg
        elif [ -f $tpath/node.tag/node.def ] ; then
            tpath+=/node.tag
        else
            echo "Invalid command" >&2
            eval $restore_shopts
            return 1
        fi
    done
    local run_cmd=$(_vyatta_app_get_node_def_field $tpath/node.def run)
    local ret=0
    if [ -n "$run_cmd" ]; then
        eval "$run_cmd"
    else
        echo "Incomplete command" >&2
        ret=1
    fi
    eval $restore_shopts
    return $ret
}

_vyatta_app_init $@
